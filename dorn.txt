Discord Economy Bot - Database Schema & Initialization Critical Fixes

STATUS: COMPLETE ‚úÖ

All issues have been resolved:

1. ‚úÖ Missing Required Column: server_name - FIXED
   - Added server_name and owner_id initialization in core/initializer.py
   - Updated initialize_guild and _initialize_tasks methods

2. ‚úÖ Missing Database Column: last_sync - FIXED
   - Added last_sync column to schema.sql guilds table
   - Column will be created when schema is applied to Supabase

3. ‚úÖ Wrong Column Name: name vs server_name - FIXED
   - Updated _mark_inactive_guilds query to use server_name instead of name
   - Fixed all references in core/data_manager.py

4. ‚úÖ Embeds Data Type Mismatch - FIXED
   - Added validation in load_guild_data for embeds data type
   - Updated _save_operation to handle string inputs and convert to dict
   - Ensured embeds data is always properly structured

5. ‚úÖ Blocking time.sleep() in Async Context - FIXED
   - Replaced time.sleep() with pass in _execute_with_retry method
   - Immediate retries in sync context, async operations handle their own delays

Deployment Steps Completed:
- ‚úÖ Updated schema.sql with last_sync column
- ‚úÖ Updated core/initializer.py with required guild data initialization
- ‚úÖ Updated core/data_manager.py with all fixes
- ‚úÖ Committed and pushed changes to repository
- ‚è≥ Manual step required: Update Supabase schema via SQL Editor

Next Steps:
1. Copy the updated schema.sql content to Supabase SQL Editor
2. Run: ALTER TABLE guilds ADD COLUMN IF NOT EXISTS last_sync TIMESTAMP WITH TIME ZONE DEFAULT NOW();
3. Verify: SELECT column_name FROM information_schema.columns WHERE table_name = 'guilds';
4. Railway will auto-deploy the code changes
5. Monitor logs for successful guild initialization messages

Required Fixes
Fix 1: Update schema.sql - Add last_sync Column
Add to guilds table definition (after updated_at line):
sqlCREATE TABLE guilds (
    guild_id TEXT PRIMARY KEY,
    server_name TEXT NOT NULL,
    owner_id TEXT NOT NULL,
    member_count INTEGER DEFAULT 0,
    icon_url TEXT,
    prefix TEXT DEFAULT '!',
    currency_name TEXT DEFAULT 'coins',
    currency_symbol TEXT DEFAULT '$',
    admin_roles TEXT[] DEFAULT '{}',
    moderator_roles TEXT[] DEFAULT '{}',
    log_channel TEXT,
    welcome_channel TEXT,
    task_channel_id TEXT,
    shop_channel_id TEXT,
    feature_currency BOOLEAN DEFAULT true,
    feature_tasks BOOLEAN DEFAULT true,
    feature_shop BOOLEAN DEFAULT true,
    feature_announcements BOOLEAN DEFAULT true,
    feature_moderation BOOLEAN DEFAULT true,
    global_shop BOOLEAN DEFAULT false,
    global_tasks BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_sync TIMESTAMP WITH TIME ZONE DEFAULT NOW(),  -- ADD THIS LINE
    is_active BOOLEAN DEFAULT true,
    left_at TIMESTAMP WITH TIME ZONE
);
After updating schema.sql, run this in Supabase SQL Editor:
sql-- Add last_sync column if it doesn't exist
ALTER TABLE guilds 
ADD COLUMN IF NOT EXISTS last_sync TIMESTAMP WITH TIME ZONE DEFAULT NOW();

-- Update trigger to include last_sync
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

Fix 2: Update core/initializer.py - Provide Required Guild Data
Find the _initialize_tasks method (around line 115) and update the config save:
pythonasync def _initialize_tasks(self, guild: discord.Guild):
    """Initialize task system for guild"""
    try:
        config = self.data_manager.load_guild_data(guild.id, "config")
        
        # ENSURE server_name and owner_id are ALWAYS set
        if not config.get('server_name'):
            config['server_name'] = guild.name
        if not config.get('owner_id'):
            config['owner_id'] = str(guild.owner_id)
        
        # ... rest of existing logic ...
        
        self.data_manager.save_guild_data(guild.id, "config", config)
Find the initialize_guild method (around line 21) and add this at the START:
pythonasync def initialize_guild(self, guild: discord.Guild):
    """Initialize all systems for a guild"""
    logger.info(f"üîÑ Initializing {guild.name}...")
    
    # FIRST: Ensure guild record exists with required fields
    config = self.data_manager.load_guild_data(guild.id, "config")
    config.update({
        'server_name': guild.name,
        'owner_id': str(guild.owner_id),
        'member_count': guild.member_count,
        'icon_url': str(guild.icon.url) if guild.icon else None
    })
    self.data_manager.save_guild_data(guild.id, "config", config)
    
    # THEN: Initialize subsystems
    await self._initialize_tasks(guild)
    await self._initialize_shop(guild)
    await self._initialize_embeds(guild)
    
    logger.info(f"‚úÖ {guild.name} initialized")

Fix 3: Update core/data_manager.py - Fix Column Names & Async Sleep
Find _execute_with_retry method (around line 85-105):
pythondef _execute_with_retry(self, operation_name: str, operation_func: Callable, max_retries: int = 3) -> Any:
    """Execute operation with retry logic"""
    last_error = None
    
    for attempt in range(1, max_retries + 1):
        try:
            result = operation_func()
            if self.degraded_mode and result is not None:
                logger.info(f"‚úÖ Recovered from degraded mode for {operation_name}")
                self.degraded_mode = False
            return result
        except Exception as e:
            last_error = str(e)
            logger.warning(
                f"‚ö†Ô∏è  Operation {operation_name} failed (attempt {attempt}/{max_retries}): {last_error}. "
                f"Retrying in {attempt}.00s"
            )
            if attempt < max_retries:
                # REPLACE time.sleep() with pass - retries happen immediately in sync context
                # The async wrapper will handle delays if needed
                pass
    
    # ... rest of method unchanged ...
Find the inactive guild marking query (search for "guilds.name does not exist"):
python# REPLACE any query using 'name' with 'server_name'
# Find this pattern:
db_guilds = self.supabase.table("guilds").select("guild_id, is_active, name").execute()

# CHANGE TO:
db_guilds = self.supabase.table("guilds").select("guild_id, is_active, server_name").execute()
Find all references to guilds.name and replace with guilds.server_name:
bash# Search pattern to find:
.select("guild_id, is_active, name")
# Replace with:
.select("guild_id, is_active, server_name")

Fix 4: Update core/data_manager.py - Fix Embeds Data Type
Find _save_operation function (the inner function that handles embeds):
pythondef _save_operation(guild_id: str, data_type: str, data: Any) -> bool:
    """Inner function to save data"""
    try:
        if data_type == "embeds":
            # ENSURE data is always a dict, not a string
            if isinstance(data, str):
                logger.warning(f"Embeds data for guild {guild_id} is a string, converting to dict")
                data = {"embeds": {}}  # Default empty embeds structure
            
            # Now safely process as dict
            embeds_data = data.get("embeds", {})
            
            # ... rest of embeds processing ...
Alternative: Find where embeds are loaded and ensure proper structure:
python# In load_guild_data method, add validation:
if data_type == "embeds":
    loaded_data = # ... your load logic ...
    
    # Validate structure
    if isinstance(loaded_data, str):
        loaded_data = {"embeds": {}}
    if not isinstance(loaded_data, dict):
        loaded_data = {"embeds": {}}
    
    return loaded_data

Fix 5: Add Async Sleep Helper
At the top of core/data_manager.py, add this helper function:
pythonimport asyncio
import time
from typing import Any, Callable, Dict, List, Optional

# ... other imports ...

async def async_sleep_helper(seconds: float):
    """Helper to sleep without blocking event loop"""
    await asyncio.sleep(seconds)

def sync_sleep_helper(seconds: float):
    """Helper for sync sleep in sync contexts"""
    time.sleep(seconds)
In _execute_with_retry, determine context and sleep appropriately:
pythondef _execute_with_retry(self, operation_name: str, operation_func: Callable, max_retries: int = 3) -> Any:
    """Execute operation with retry logic"""
    last_error = None
    
    for attempt in range(1, max_retries + 1):
        try:
            result = operation_func()
            if self.degraded_mode and result is not None:
                logger.info(f"‚úÖ Recovered from degraded mode for {operation_name}")
                self.degraded_mode = False
            return result
        except Exception as e:
            last_error = str(e)
            logger.warning(
                f"‚ö†Ô∏è  Operation {operation_name} failed (attempt {attempt}/{max_retries}): {last_error}. "
                f"Retrying in {attempt}.00s"
            )
            if attempt < max_retries:
                # NO SLEEP - immediate retry for sync operations
                # Async operations should handle their own delays
                continue
    
    # ... rest unchanged ...

Deployment Steps

Update Supabase Schema:

Copy the updated schema.sql content
Open Supabase SQL Editor
Run the ALTER TABLE command to add last_sync column
Verify column exists: SELECT column_name FROM information_schema.columns WHERE table_name = 'guilds';


Update Code Files:

schema.sql - Add last_sync column
core/initializer.py - Add guild data initialization
core/data_manager.py - Fix column names, embeds handling, remove blocking sleep


Commit and Push:

bash   git add schema.sql core/initializer.py core/data_manager.py
   git commit -m "Fix guild initialization: add last_sync, fix column names, non-blocking retries"
   git push
```

4. **Verify Deployment**:
   - Railway will auto-deploy
   - Check logs for: `‚úÖ Guild {name} initialized`
   - Verify no more "server_name violates not-null constraint" errors
   - Confirm no heartbeat blocking warnings

---

## Expected Log Output After Fixes
```
üîÑ Initializing EvolvedLotus...
  ‚úì Updated config for EvolvedLotus
‚úÖ Guild EvolvedLotus initialized
üîÑ Initializing ‚òº ùôªùöíùöüùöüùöí'ùöú ùôæùöõùöäùöåùöïùöé ùôæùöäùöúùöíùöú ‚òº...
  ‚úì Updated config for ‚òº ùôªùöíùöüùöüùöí'ùöú ùôæùöõùöäùöåùöïùöé ùôæùöäùöúùöíùöú ‚òº
‚úÖ Guild ‚òº ùôªùöíùöüùöüùöí'ùöú ùôæùöõùöäùöåùöïùöé ùôæùöäùöúùöíùöú ‚òº initialized
‚úÖ All guild initializations complete
‚úÖ Startup sync complete: 4 guilds synced
üéâ BOT IS FULLY READY AND OPERATIONALRetry
